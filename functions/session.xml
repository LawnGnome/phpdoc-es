 <reference id="ref.session">
  <title>Funciones para la Gesti&oacute;n de Sesiones</title>
  <titleabbrev>Sesiones</titleabbrev>
  <partintro>
   <para>
    El soporte de sesiones en PHP es b&aacute;sicamente un sistema que preserva
    ciertos datos en una serie de accesos. Esto permite construir
    aplicaciones m&aacute;s personalizadas e incrementar el atractivo de un
    website.
   </para>

   <para>
    Si ya est&aacute; familiarizado con la gesti&oacute;n de sesi&oacute;n de PHPLIB, apreciar&aacute;
    que algunos conceptos son similares al soporte de sesiones de PHP.
   </para>

   <para>
    A cada visitante que acceda a su web se le asigan un &uacute;nico id,
    el conocido id de sesi&oacute;n.&Eacute;ste se almacena en una cookie del usuario
    o bien se propaga con la URL.
   </para>

   <para>
    El soporte de sesi&oacute;n le permite transportar tantas variables como
    desee a trav&eacute;s de las solicitudes del cliente. Cuando un visitante
    accede a su web, PHP chequea autom&aacute;ticamente (si session.auto_start
    est&aacute; puesta a 1), manualmente (si a&ntilde;ade el comando
    <function>session_start</function>) o implicitamente (al a&ntilde;adir
    <function>session_register</function>) si se ha establecido una sesi&oacute;n
    concreta con la llamada. Si es as&iacute;, el entorno grabado es reproducido.
   </para>

   <para>
    Todas las variables registradas son serializadas tras finalizar la 
    solicitud. Las variables registradas que no est&eacute;n definidas se marcan
    como no definidas. En los accesos posteriores, estas variables no
    las define el m&oacute;dulo de sisi&oacute;n, a no ser que las defina el usuario 
    despu&eacute;s.
   </para>

   <para>
    Los par&aacute;metros de configuraci&oacute;n
    <literal>track_vars</literal> y <literal>gpc_globals</literal>
    influyen en como se recuperan las variables de sesi&oacute;n. Si
    <literal>track_vars</literal> est&aacute; activado, las variables
    recuperadas estar&aacute;n guardadas en la matriz asociativa
    $HTTP_STATE_VARS. Si <literal>gpc_globals</literal> est&aacute; activado,
    las variables de sesi&oacute;n se recuperar&aacute;n como variables globales. Si
    ambos par&aacute;metros est&aacute;n activados, las variables globales y los
    registros de $HTTP_STATE_VARS valdr&aacute;n lo mismo.
   </para>

   <para>
    Hay dos formas de propagar un id de sesi&oacute;n:
    
    <itemizedlist>
     <listitem><simpara>
      Cookies</simpara></listitem>
     <listitem><simpara>
      par&aacute;metros URL</simpara></listitem>
    </itemizedlist></para>

   <para>
    El m&oacute;dulo de sesi&oacute;n soporta ambos m&eacute;todos. Las Cookies son ideales,
    pero como su permanencia no la controla el servidor, sino el 
    cliente no nos podemos fiar. El segundo m&eacute;todo integra el id de
    sesi&oacute;n en las URLs.
   </para>

   <para>
    PHP es capaz de hacer esto de forma trasparente cuando se ha
    compilado con <literal>--enable-trans-sid</literal>. Si activa
    esta opci&oacute;n las URIs relativas se cambiar&aacute;n autom&aacute;ticamente para 
    contener el id de sesi&oacute;n. Otra posibilidad es usar la constante
    <literal>SID</literal> siempre definida, si el cliente no manda
    la cookie apropiada.  <literal>SID</literal> es de la forma
    <literal>session_name=session_id</literal> o bien es una cadena
    vac&iacute;a.
   </para>

   <para>
    El siguiente ejemplo muestra como registrar una variable y como 
    enlazarla correctamente a otra p&aacute;gina usando SID.
  
   <example>
    <title>Contando el n&uacute;mero de hits en un usuario sencillo</title>
    <programlisting>
&lt;?php

session_register("count");

$count++;

?&gt;

Hola, visitante, has visto esta p&aacute;gina &lt;? echo $count; ?&gt; veces.&lt;p&gt;

&lt;?
# el &lt;?=SID?&gt; es necesario para preservar el id de la sesi&oacute;n
# para el caso en que el usuario haya descativado las Cookies
?&gt;

 Para continuar, &lt;A HREF="nextpage.php?&lt;?=SID?&gt;"&gt;pulse aqu&iacute;&lt;/A&gt;
</programlisting></example></para>

   <para>
    Para implementar el almacenamiento en base de datos necesita c&oacute;digo
    PHP y la funci&oacute;n a nivel de usuario <function>session_set_save_handler</function>.
    Tendr&iacute;a que extender las siguientes funciones para soportar MySQL y 
    otras bases de datos.
   </para>
   <para>
    <example>
     <title>
      Manejo de <function>session_set_save_handler</function>
     </title>
     <programlisting role="php">
&lt;?php

function open ($save_path, $session_name) {
    echo "open ($save_path, $session_name)\n";
    return true;
}

function close () {
    echo "close\n";
    return true;
}

function read ($key) {
    echo "write ($key, $val)\n";
    return "foo|i:1;";
}

function write ($key, $val) {
    echo "write ($key, $val)\n";
    return true;
}

function destroy ($key)
    return true;
}

function gc ($maxlifetime) {
    return true;
}

session_set_save_handler ("open", "close", "read", "write", "destroy", "gc");

session_start ();

$foo++;

?>
     </programlisting>
    </example>
   </para> 

   <para>
    Producir&aacute; los siguientes resultados:
   </para>

   <para>
    <programlisting>
$ ./php save_handler.php
Content-Type: text/html
Set-cookie: PHPSESSID=f08b925af0ecb52bdd2de97d95cdbe6b

open (/tmp, PHPSESSID)
read (f08b925af0ecb52bdd2de97d95cdbe6b)
write (f08b925af0ecb52bdd2de97d95cdbe6b, foo|i:2;)
close
    </programlisting>
   </para>

   <para>
    El <literal>&lt;?=SID?&gt;</literal> no es necesario, si
    <literal>--enable-trans-sid</literal> se us&oacute; para compilar PHP.
   </para>
   
   <para>
    El sistema gestor de sesiones soporta una serie de opciones de 
    configuraci&oacute;n que puede poner en su fichero php.ini. Las vemos 
    a continuaci&oacute;n.

    <itemizedlist>
     <listitem><simpara>
      <literal>session.save_handler</literal> define el nombre del
      handler que se usa para almacenar y recuperar los datos asociados
      con la sesi&oacute;n.  Por defecto es
      <literal>files</literal>.</simpara></listitem>

     <listitem><simpara>
      <literal>session.save_path</literal> define el argumento que se
      pasa al handler de grabaci&oacute;n. Si escoge el handler por defecto,
      &eacute;ste es el path donde los ficheros son creados.  Por defecto es
      <literal>/tmp</literal>.</simpara></listitem>

     <listitem><simpara>
      <literal>session.name</literal> especifica el nombre de la sesi&oacute;n 
      el cual se usa como nombre de la cookie. Debe contener s&oacute;lo 
      caracteres alfanum&eacute;ricos.  Por defecto es 
      <literal>PHPSESSID</literal>.</simpara></listitem>

     <listitem><simpara>
      <literal>session.auto_start</literal> especifica si el m&oacute;dulo de 
      sesi&oacute;n inicia autom&aacute;ticamente una sesi&oacute;n en la solicitud inicial.
      Por defecto es <literal>0</literal>
      (disabled).</simpara></listitem>

     <listitem><simpara>
      <literal>session.lifetime</literal> especifica el tiempo de vida
      de una cookie en segundos que se le env&iacute;a al navegador. El valor
      0 significa "hasta que se cierre el navegador". Por defecto es
      <literal>0</literal>.</simpara></listitem>

     <listitem><simpara>
      <literal>session.serialize_handler</literal> define el nombre del 
      handler que se usa para serializr/deserializar datos. Actualmente,
      est&aacute;n soportados un formato interno de PHP (con nombre 
      <literal>php</literal>) y WDDX (con nombre 
      <literal>wddx</literal>). WDDX s&oacute;lo est&aacute; disponible si se compila
      PHP con <link linkend="ref.wddx">WDDX
      support</link>. Por defecto es
      <literal>php</literal>.</simpara></listitem>

     <listitem><simpara>
      <literal>session.gc_probability</literal> especifica la 
      probabilidad en tanto por cien de que la rutina de gc (garbage 
      collection) se en cada solicitud. Por defecto es
      <literal>1</literal>.</simpara></listitem>

     <listitem><simpara>
      <literal>session.gc_maxlifetime</literal> especifica el n&uacute;mero de
      segundos despu&eacute;s de los cuales los datos son considerados como
      'basura' y por tanto limpiados mediante gc.</simpara></listitem>

     <listitem><simpara>
      <literal>session.referer_check</literal> determina si los ids
      de sesi&oacute;n referidos a sitios externos son eliminados. Si los ids
      de sesi&oacute;n se propagan usando el m&eacute;todo de URL los usuarios que 
      no conocen sus implicaciones podr&iacute;an exponer sin querer los ids de
      sesi&oacute;n. Esto podr&iacute;a generar problemas de seguridad, que este chequeo
      trata de eliminar. Por defecto es 
      <literal>0</literal>.</simpara></listitem>

     <listitem><simpara>
      <literal>session.entropy_file</literal> da una ruta a un recurso 
      externo (un fichero) que se usar&aacute; como fuente adicional de entrop&iacute;a
      en la creaci&oacute;n del id de sesi&oacute;n. Un ejemplo ser&iacute;a
      <literal>/dev/random</literal> o bien <literal>/dev/urandom</literal>
      que est&aacute;n disponibles en muchos sistemas Unix.</simpara></listitem>

     <listitem><simpara>
      <literal>session.entropy_length</literal> especifica el n&uacute;mero de
      bytes que se leer&aacute;n del fichero arriba indicado. Por defecto es
      <literal>0</literal>(desactivado).</simpara></listitem>

     <listitem><simpara>
      <literal>session.use_cookies</literal> especifica si el m&oacute;dulo usar&aacute;
      cookies para almacenar el id de sesi&oacute;n en el lado del cliente. Por 
      defecto es <literal>1</literal>
      (activado).</simpara></listitem>

    </itemizedlist>

   <note>
    <para>
     La gesti&oacute;n de sesiones se a&ntilde;adi&oacute; en PHP 4.0.</para>
   </note></para>
  </partintro>

  <refentry id="function.session-start">
   <refnamediv>
    <refname>session_start</refname>
    <refpurpose>Inicializa las variables de sesi&oacute;n</refpurpose>
   </refnamediv>
   <refsect1>
    <title>Descripci&oacute;n</title>
    <funcsynopsis>
     <funcdef>bool <function>session_start</function></funcdef>
     <void/>
    </funcsynopsis>
    <simpara>
     <function>session_start</function> crea una sesi&oacute;n (o continua
     con la actual basada en el id de sesi&oacute;n pasado mediante una
     variable GET (o una cookie).</simpara>
    <simpara>
     Esta funci&oacute;n siempre devuelve true.</simpara>
    <note>
     <para>
      Esta funci&oacute;n se a&ntilde;adi&oacute; en PHP 4.0.</para>
    </note>
   </refsect1>
  </refentry>

  <refentry id="function.session-destroy">
   <refnamediv>
    <refname>session_destroy</refname>
    <refpurpose>Elimina toda la informaci&oacute;n registrada en una sesi&oacute;n</refpurpose>
   </refnamediv>
   <refsect1>
    <title>Descripci&oacute;n</title>
    <funcsynopsis>
     <funcdef>bool <function>session_destroy</function></funcdef>
     <void/>
    </funcsynopsis>
    <simpara>
     <function>session_destroy</function> elimina todos los datos 
     asociados a la sesi&oacute;n en curso.</simpara>
    <simpara>
     Esta funci&oacute;n siempre devuelve true.</simpara>
    <note>
     <para>
      Esta funci&oacute;n se a&ntilde;adi&oacute; en PHP 4.0.</para>
    </note>
   </refsect1>
  </refentry>

  <refentry id="function.session-name">
   <refnamediv>
    <refname>session_name</refname>
    <refpurpose>Obtiene y/o establece el nombre de la sesi&oacute;n en curso</refpurpose>
   </refnamediv>
   <refsect1>
    <title>Descripci&oacute;n</title>
    <funcsynopsis>
     <funcdef>string <function>session_name</function></funcdef>
     <paramdef>string <parameter><optional>name</optional></parameter></paramdef>
    </funcsynopsis>
    <para>
     <function>session_name</function> devuelve el nombre de la sesi&oacute;n en curso.
     Si <parameter>name</parameter> est&aacute; especificado, el nombre de la sesi&oacute;n 
     en curso es cambiado por &eacute;ste.</para>
    <para>
     El nombre de la sesi&oacute;n referencia el id de sesi&oacute;n en las cookies y en las 
     URLs. Deber&iacute;a contener s&oacute;lo caracteres alfanum&eacute;ricos; debe ser corto y
     descriptivo (para que lo vean los usuarios que tengan activados los warnings 
     de cookies en su navegador). El nombre de la sesi&oacute;n es inicializado a su
     valor por defecto guardado en <literal>session.name</literal>
     en el momento de inicio de la sesi&oacute;n. As&iacute;, se hace necesario llamar a
     <function>session_name</function> en cada solicitud (y antes de que 
     <function>session_start</function> o
     <function>session_register</function> sean llamados).</para> 
    <example>
     <title>Ejemplos de <function>session_name</function></title>
     <programlisting>
&lt;?php

# Define el nombre de sesi&oacute;n como WebsiteID

$previous_name = session_name("WebsiteID");

echo "El nombre anterior era $previous_name&lt;p&gt;";
     </programlisting>
    </example>
    <note>
     <para>
      Esta funci&oacute;n se a&ntilde;adi&oacute; en PHP 4.0.</para>
    </note>
   </refsect1>
  </refentry>

  <refentry id="function.session-module-name">
   <refnamediv>
    <refname>session_module_name</refname>
    <refpurpose>Obtiene y/o establece el m&oacute;dulo de sesi&oacute;n en curso</refpurpose>
   </refnamediv>
   <refsect1>
    <title>Descripci&oacute;n</title>
    <funcsynopsis>
     <funcdef>string <function>session_module_name</function></funcdef>
     <paramdef>string <parameter><optional>module</optional></parameter></paramdef>
    </funcsynopsis>
    <para>
     <function>session_module_name</function> devuelve el nombre del m&oacute;dulo 
     de sesi&oacute;n en curso. Si <parameter>module</parameter> est&aacute; especificado,
     dicho m&oacute;dulo ser&aacute; usado en su lugar.
    <note>
     <para>
      Esta funci&oacute;n se a&ntilde;adi&oacute; en PHP 4.0.</para>
    </note></para>
   </refsect1>
  </refentry>

  <refentry id="function.session-save-path">
   <refnamediv>
    <refname>session_save_path</refname>
    <refpurpose>Obtiene o establece el path de grabaci&oacute;n de la sesi&oacute;n en curso</refpurpose>
   </refnamediv>
   <refsect1>
    <title>Descripci&oacute;n</title>
    <funcsynopsis>
     <funcdef>string <function>session_save_path</function></funcdef>
     <paramdef>string <parameter><optional>path</optional></parameter></paramdef>
    </funcsynopsis>
    <para>
     <function>session_save_path</function> devuelve la ruta del directorio que se est&aacute; 
     usando para grabar la sesi&oacute;n en curso. Si el par&aacute;metro <parameter>path</parameter>
     se indica, el path donde se graben los datos cambiar&aacute;.
    <note>
     <para>
      En algunos sistemas operativos, puede que le interese especificar un path en el 
      sistema de ficheros que maneje eficazmente grandes cantidades de peque&ntilde;os 
      ficheros. Por ejemplo, bajo Linux, reiserfs puede dar mejor rendimiento que
      ext2fs.</para>
    </note>
    <note>
     <para>
      Esta funci&oacute;n se a&ntilde;adi&oacute; en PHP 4.0.</para>
    </note></para>
   </refsect1>
  </refentry>

  <refentry id="function.session-id">
   <refnamediv>
    <refname>session_id</refname>
    <refpurpose>Obtiene o establece el id de sesi&oacute;n en curso</refpurpose>
   </refnamediv>
   <refsect1>
    <title>Descripci&oacute;n</title>
    <funcsynopsis>
     <funcdef>string <function>session_id</function></funcdef>
     <paramdef>string <parameter><optional>id</optional></parameter></paramdef>
    </funcsynopsis>
    <para>
     <function>session_id</function> devuelve el id de la sesi&oacute;n en curso. Si 
     se especifica <parameter>id</parameter>, se reemplazar&aacute; el id de la actual
     sesi&oacute;n.</para>
    <para>
     directorio usado para grabar los datos de sesi&oacute;n. Si <parameter>path</parameter>
     se especifica, el path donde se graben los datos cambiar&aacute;.</para>
    <para>
     La constante <systemitem>SID</systemitem> se puede usar tambi&eacute;n para 
     obtener el nombre e id de la sesi&oacute;n en curso como una cadena preparada
     para ser a&ntilde;adida a las URLs.
    <note>
     <para>
      Esta funci&oacute;n se a&ntilde;adi&oacute; en PHP 4.0.</para>
    </note></para>
   </refsect1>
  </refentry>

  <refentry id="function.session-register">
   <refnamediv>
    <refname>session_register</refname>
    <refpurpose>Registra una o m&aacute;s variables en la sesi&oacute;n en
    curso</refpurpose>
   </refnamediv>
   <refsect1>
    <title>Descripci&oacute;n</title>
    <funcsynopsis>
     <funcdef>bool <function>session_register</function></funcdef>
     <paramdef>mixed <parameter>name</parameter></paramdef>
     <paramdef>mixed
      <parameter><optional>...</optional></parameter></paramdef>
    </funcsynopsis>
    <para>
     <function>session_register</function> tiene un n&uacute;mero variable 
     de argumentos, cada uno de los cuales puede ser una cadena que 
     contiene el nombre de la variable, o un vector que contenga 
     esos nombres de variables u otros vectores. Por cada variable que
     se encuentre, <function>session_register</function> registra el 
     nombre de la variable como variable global en la sesi&oacute;n en 
     curso.</para>
    <para>
     Esta funci&oacute;n devuelve true cuando la variable se registra con 
     &eacute;xito en la sesi&oacute;n.
    <note>
     <para>
      Esta funci&oacute;n se a&ntilde;adi&oacute; en PHP 4.0.</para>
    </note></para>
   </refsect1>
  </refentry>

  <refentry id="function.session-unregister">
   <refnamediv>
    <refname>session_unregister</refname>
    <refpurpose>Desliga una variable de la sesi&oacute;n en curso</refpurpose>
   </refnamediv>
   <refsect1>
    <title>Descripci&oacute;n</title>
    <funcsynopsis>
     <funcdef>bool <function>session_unregister</function></funcdef>
     <paramdef>string <parameter>name</parameter></paramdef>
    </funcsynopsis>
    <para>
     <function>session_unregister</function> desliga (olvida)
     la variable global llamada <parameter>name</parameter> de la
     sesi&oacute;n en curso.</para>
    <para>
     Esta funci&oacute;n devuelve true cuando la variable se ha desligado
     de la sesi&oacute;n.
    <note>
     <para>
      Esta funci&oacute;n se a&ntilde;adi&oacute; en PHP 4.0.</para>
    </note></para>
   </refsect1>
  </refentry>

  <refentry id="function.session-is-registered">
   <refnamediv>
    <refname>session_is_registered</refname>
    <refpurpose>Aveigua si una variable est&aacute; registrada en una
    sesi&oacute;n</refpurpose>
   </refnamediv>
   <refsect1>
    <title>Descripci&oacute;n</title>
    <funcsynopsis>
     <funcdef>bool <function>session_is_registered</function></funcdef>
     <paramdef>string <parameter>name</parameter></paramdef>
    </funcsynopsis>
    <para>
     <function>session_is_registered</function> devuelve true si hay 
     una variable que se llame <parameter>name</parameter> registrada 
     en la sesi&oacute;n en curso.
    <note>
     <para>
      Esta funci&oacute;n se a&ntilde;adi&oacute; en PHP 4.0.</para>
    </note></para>
   </refsect1>
  </refentry>

  <refentry id="function.session-decode">
   <refnamediv>
    <refname>session_decode</refname>
    <refpurpose>Extrae los datos de sesi&oacute;n a partir de una
    cadena</refpurpose>
   </refnamediv>
   <refsect1>
    <title>Descripci&oacute;n</title>
    <funcsynopsis>
     <funcdef>bool <function>session_decode</function></funcdef>
     <paramdef>string <parameter>data</parameter></paramdef>
    </funcsynopsis>
    <para>
     <function>session_decode</function> extrae los datos de
     sesi&oacute;n en <parameter>data</parameter>, dando valores a
     las variables almacenadas en la sesi&oacute;n.
    <note>
     <para>
      Esta funci&oacute;n se a&ntilde;adi&oacute; en PHP 4.0.</para>
    </note></para>
   </refsect1>
  </refentry>

  <refentry id="function.session-encode">
   <refnamediv>
    <refname>session_encode</refname>
    <refpurpose>Codifica los datos de la sesi&oacute;n en curso en una
    cadena</refpurpose>
   </refnamediv>
   <refsect1>
    <title>Descripci&oacute;n</title>
    <funcsynopsis>
     <funcdef>bool <function>session_encode</function></funcdef>
     <void/>
    </funcsynopsis>
    <para>
     <function>session_encode</function> devuelve una cadena
     con los contenidos de la sesi&oacute;n en curso dentro.
    <note>
     <para>
      Esta funci&oacute;n se a&ntilde;adi&oacute; en PHP 4.0.</para>
    </note></para>
   </refsect1>
  </refentry>

 </reference>

<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:t
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
sgml-parent-document:nil
sgml-default-dtd-file:"../../manual.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
-->
